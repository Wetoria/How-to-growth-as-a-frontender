# 谈谈我是如何进行性能优化

这篇文章主要讲讲在最近的这个项目中遇到的性能问题，以及我是如何进行优化的。

## 遇到过的性能问题

### 房间组件性能

最近的项目中主要是房地产相关的管理系统，其中有一个表格组件是用来描述房间模型的，性能问题主要是在房间超过1000个以后的渲染效果上，具体的房间组件效果，可以参考《[谈谈我成为前端的这两年](./01.谈谈我成为前端的这两年.md)》这篇文章。

这个组件主要出现过以下几个性能问题：

- 当生成的房间超过 1000 时，从第二步填写的房间单元、房号、楼层等信息，到渲染出可操作的房间表格的时间过久
- 当生成的车位超过 2000 时，点击全选按钮选中所有房间直至整个选中效果显示出来的等待时间过长

### SQL 查询时间过长

在过去的某个项目中，有个报表统计的 SQL，执行时间达到了 4 分钟，用户体验不良，需要优化。

## 优化的思路

性能优化的核心思路是，找出影响性能的主要关键点，然后选择更优的方式去解决，所以在进行性能优化时，需要先分析出代码中影响性能的部分，然后再针对性的去解决。

### 房间组件优化过程

#### 生成房间

因为是前端功能，所以房间组件的渲染性能包括代码逻辑部分的处理时间，以及处理完毕到渲染完成这两部分内容。在尝试优化这个组件时，曾经尝试通过谷歌浏览器的 Performance 来记录整个处理过程的性能开销，但是整个 4 分钟的快照，结果集是密密麻麻的，很难找到关键所在，至少目前的我不会分析。

在尝试用 Performance 分析失败以后，我尝试逐步分析性能开销，在生成房间表格所需要的方法中，用 `time`/`timeEnd` 记录下整个方法的处理时间，发现性能还是理想的，那么问题主要出在渲染过程中。

项目使用的是 Vue，在代码的性能没有问题时，我在生成方法最后使用 `time` 开始计时，在 `updated` 里使用 `timeEnd` 结束计时，就这样记录下代码从处理完毕。然后我通过不断删减模板里标签上的属性，删除标签等操作，一段段的分析究竟是哪一块模板的影响了性能。最后发现 `el-input` 上的 `ref` 属性，以及整个 `el-input` 特别影响性能，然后用 `div` 标签加上 `contenteditable` 属性，模拟这个输入效果解决这一部分的性能问题。

#### 车位选中

车位选中效果的渲染性能，依旧是使用 `time/timeEnd` 记录开销，然后逐步分析代码的问题所在，然后尝试用其他办法来避免。而这个问题也让我写下了《[$emit有时也并没有那么好用](https://juejin.im/post/5e15fba66fb9a0482343f9d6)》这篇文章。

### 优化 SQL

优化报表 SQL 时，依旧是通过不断分析每一段 SQL 的性能情况，找到影响性能的关键部分是在 SELECT 中的子查询中，然后通过连表实现相同查询功能解决的性能问题。

## 总结

上面举的三个例子，都是通过逐步/逐段分析代码，找到影响性能的代码所在，然后选择更优的方式去实现相同的功能。所以，知道如何记录性能开销是必备的一个前提。其次，在分析出关键代码以后，要能知道更优的实现方式，这也是必不可少的。最后，这种逐步分析的思路，是所有“调试”过程中通用的思想。

